import React, { useState, useEffect, useRef } from "react";
import { io } from "socket.io-client";
import axios from "axios";
import { useParams } from "react-router-dom";

import "./ChatAdmin.css";
import { useNavigate } from "react-router-dom";
import { user } from "@nextui-org/react";
import avat from "../../../public/assets/images/avatars/lufy2.jpg";
const ENDPOINT = "http://localhost:3001"; // ƒê·ªãa ch·ªâ c·ªßa server Node.js

const ChatAdmin = () => {
  const navigate = useNavigate();
  const [inputMess, setinputMess] = useState("");
  const [inputUser, setinputUser] = useState("");
  const [listUser, setListUser] = useState([]);
  const [NguoiMaBanMuonNhanTin, setNguoiMaBanMuonNhanTin] = useState();

  const [IdCoversation, setIdCoversation] = useState("");

  const id = useParams();
  const [userId, setUserId] = useState('');
  const [ImageUserWantMess, setImageUserWantMess] = useState();
  const [IdAdminChat, setIdAdminChat] = useState('');
  const idValue = Object.values(id)[0];
  console.log("id nguoi set vata", idValue);
  const [TinNhan, setTinNhan] = useState([]);
  const [ShowMenuAvatar, setShowMenuAvatar] = useState(false);
  const [DataAllUserBackend, setDataAllUserBackend] = useState([])
  const [avatarUrl, setAvatarUrl] = useState('');
  const [AvataKH, setAvataKH] = useState('');
  const [selectedUser, setSelectedUser] = useState(null);
  const handleShowMenuAvatar = () => {
    setShowMenuAvatar(!ShowMenuAvatar);
  };
  const tokenSetStorage = sessionStorage.getItem("accessToken");

  const axiosWithCredentials = axios.create({
    withCredentials: true, // B·∫≠t s·ª≠ d·ª•ng cookie trong y√™u c·∫ßu
    headers: {
      Authorization: `Bearer ${tokenSetStorage}`, // Thay yourToken b·∫±ng token c·ªßa b·∫°n
    },
  });


  useEffect(() => {
    // Thi·∫øt l·∫≠p k·∫øt n·ªëi v·ªõi server socket
    const socket = io(ENDPOINT);

    // L·∫Øng nghe s·ª± ki·ªán "message" t·ª´ server
    socket.on("message", (data) => {
      // Tr√≠ch xu·∫•t tin nh·∫Øn t·ª´ d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
      const newMessage = data.messageNe;
      // C·∫≠p nh·∫≠t state TinNhan b·∫±ng c√°ch th√™m tin nh·∫Øn m·ªõi v√†o m·∫£ng tin nh·∫Øn ƒë√£ c√≥
      setTinNhan((prevMessages) => [...prevMessages, newMessage]);
    });

    // Ng·∫Øt k·∫øt n·ªëi khi component unmount
    return () => {
      socket.disconnect();
    };
  }, []);
  const [ImageOfMe, setImageOfMe] = useState();
  const [NameOfMe, setNameOfMe] = useState();
  console.log("imageofme=>", ImageOfMe);

  useEffect(() => {
    const fetchListUser = async () => {
      try {
        const response = await axios.get(`${ENDPOINT}/allusers`);
        // L·ªçc d·ªØ li·ªáu ƒë·ªÉ ch·ªâ l·∫•y user c√≥ _id tr√πng v·ªõi idValue
        const filteredUsers = response.data.filter(
          (user) => user._id === idValue
        );
        // L∆∞u danh s√°ch ng∆∞·ªùi d√πng ƒë√£ l·ªçc v√†o state
        setListUser(filteredUsers);
        // N·∫øu c√≥ user trong danh s√°ch ƒë√£ l·ªçc, th√¨ l·∫•y ·∫£nh c·ªßa user ƒë·∫ßu ti√™n v√† l∆∞u v√†o state
        if (filteredUsers.length > 0) {
          setImageOfMe(filteredUsers[0].avt);
          setNameOfMe(filteredUsers[0].username);
        }
      } catch (error) {
        console.error("Error fetching list of users:", error);
      }
    };

    fetchListUser(); // G·ªçi h√†m l·∫•y danh s√°ch ng∆∞·ªùi d√πng khi component ƒë∆∞·ª£c t·∫°o
  }, [idValue]); // Th√™m idValue v√†o dependency array ƒë·ªÉ useEffect ƒë∆∞·ª£c g·ªçi l·∫°i khi idValue thay ƒë·ªïi

  useEffect(() => {
    const fetchListUser = async () => {
      try {
        const response = await axios.get(`${ENDPOINT}/allusers`);
        setListUser(response.data);
      } catch (error) {
        console.error("Error fetching list of users:", error);
      }
    };

    fetchListUser(); // G·ªçi h√†m l·∫•y danh s√°ch ng∆∞·ªùi d√πng khi component ƒë∆∞·ª£c t·∫°o
  }, []);
  const handleIconCaVoi = async () => {
    try {
      // G·ª≠i y√™u c·∫ßu POST ƒë·∫øn server
      const usernameAdmin = 'admin'
      const response = await axios.post(
        "http://localhost:3001/api/addMessageToConversation",
        {
          senderUserId: usernameAdmin, // ID c·ªßa ng∆∞·ªùi g·ª≠i tin nh·∫Øn
          content: "üê≥", // N·ªôi dung c·ªßa tin nh·∫Øn
          conversationId: IdCoversation, // ID c·ªßa cu·ªôc tr√≤ chuy·ªán
        }
      );
      console.log("id", idValue, "mess", inputMess, "coverid=>", IdCoversation);
      console.log("backend gui len ne =>", response.data.messageNe.message);

      // N·∫øu y√™u c·∫ßu th√†nh c√¥ng, in ra th√¥ng b√°o "G·ª≠i tin nh·∫Øn th√†nh c√¥ng"
      console.log("G·ª≠i tin nh·∫Øn th√†nh c√¥ng");

      setinputMess("");
      const responseMess = await axios.post(
        "http://localhost:3001/api/getMessages",
        {
          conversationId: IdCoversation, // Truy·ªÅn id c·ªßa user ƒë√≥ xu·ªëng server
        }
      );
      setTinNhan(responseMess.data);

      // N·∫øu b·∫°n c·∫ßn x·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ server, b·∫°n c√≥ th·ªÉ l√†m ·ªü ƒë√¢y
      // V√≠ d·ª•: const data = response.data;
    } catch (error) {
      // N·∫øu c√≥ l·ªói x·∫£y ra, in ra th√¥ng b√°o l·ªói
      console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", error);
    }
  };
  const SendMessNe = async () => {
    if (!inputMess) {
      return;
    }
    const usernameAdmin = 'admin'
    console.log('check conversationId', IdCoversation)

    try {
      // G·ª≠i y√™u c·∫ßu POST ƒë·∫øn server
      if (IdCoversation && IdAdminChat && inputMess) {
        const response = await axios.post(
          `${ENDPOINT}/api/addMessageToConversation`,
          {
            senderUserId: usernameAdmin, // ID c·ªßa ng∆∞·ªùi g·ª≠i tin nh·∫Øn
            content: inputMess, // N·ªôi dung c·ªßa tin nh·∫Øn
            conversationId: IdCoversation, // ID c·ªßa cu·ªôc tr√≤ chuy·ªán
          }
        );
        console.log("id", IdAdminChat, "mess", inputMess, "coverid=>", IdCoversation);
        console.log("backend gui len ne =>", response.data.messageNe.message);

        setinputMess("");

      }


      // N·∫øu y√™u c·∫ßu th√†nh c√¥ng, in ra th√¥ng b√°o "G·ª≠i tin nh·∫Øn th√†nh c√¥ng"
      console.log("G·ª≠i tin nh·∫Øn th√†nh c√¥ng");

      // C·∫≠p nh·∫≠t tin nh·∫Øn m·ªõi v√†o state

      console.log('check conversationId2', IdCoversation)
      if (IdCoversation) {
        console.log('id cuoc tro chuyen', IdCoversation)
        const responseMess = await axios.post(
          `${ENDPOINT}/api/getMessages`,
          {
            conversationId: IdCoversation,
          }
        );
        setTinNhan(responseMess.data);

      }


      // N·∫øu b·∫°n c·∫ßn x·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ server, b·∫°n c√≥ th·ªÉ l√†m ·ªü ƒë√¢y
      // V√≠ d·ª•: const data = response.data;
    } catch (error) {
      // N·∫øu c√≥ l·ªói x·∫£y ra, in ra th√¥ng b√°o l·ªói
      console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", error);
    }
  };
  const sendMessage = () => {
    alert("oke");
    const newMessage = { IdUserSend: idValue, message: inputMess };

    axios
      .post(`${ENDPOINT}/messages`, newMessage)
      .then(() => {
        setinputMess("");
      })
      .catch((error) => {
        console.error("Error sending message:", error);
      });
  };
  const handlePressEnter = async (event) => {
    if (event.charCode == 13) {
      await SendMessNe();
      event.preventDefault();
    }
  };


  const handleUserIb = async (user) => {
    setSelectedUser(user.taikhoan);
    setAvataKH(user.avatar)
    console.log('check avata =>', user.avatar)
    try {
      const response = await axios.get(`http://localhost:3001/api/getUserByUsername/${user.taikhoan}`);
      const { userId } = response.data;
      setUserId(userId);
      console.log('check id user', userId)

    } catch (error) {
      if (error.response && error.response.status === 404) {
        console.log('User not found');
      } else {

        console.log('An error occurred during the search.');
      }
    }
    const usernameAdmin = 'admin'
    try {
      const response = await axios.get(`http://localhost:3001/api/getUserByUsername/${usernameAdmin}`);
      const { userId } = response.data;
      setIdAdminChat(userId);
      console.log('check id user', userId)

    } catch (error) {
      if (error.response && error.response.status === 404) {
        console.log('User not found');
      } else {

        console.log('An error occurred during the search.');
      }
    }
    // console.log('check cai nay di', IdAdminChat)
    // console.log('check cai nay di2', userId)
    try {
      if (IdAdminChat, userId) {
        // G·ª≠i y√™u c·∫ßu POST ƒë·∫øn server
        const response = await axios.post(
          "http://localhost:3001/api/createConversation",
          {
            participants: [IdAdminChat, userId], // Truy·ªÅn id c·ªßa user ƒë√≥ xu·ªëng server
          }
        );
        setIdCoversation(response.data.conversationId);
        console.log("id conver =>", IdCoversation);
      }
      if (IdCoversation) {
        const responseMess = await axios.post(
          "http://localhost:3001/api/getMessages",
          {
            conversationId: IdCoversation, // Truy·ªÅn id c·ªßa user ƒë√≥ xu·ªëng server
          }
        );
        setTinNhan(responseMess.data);

        console.log("check tin nh·∫Øn1 =>", responseMess.data);
      }



      // N·∫øu y√™u c·∫ßu th√†nh c√¥ng, in ra th√¥ng b√°o "T·∫°o cu·ªôc tr√≤ chuy·ªán th√†nh c√¥ng"
      console.log("T·∫°o cu·ªôc tr√≤ chuy·ªán th√†nh c√¥ng");
      setNguoiMaBanMuonNhanTin(Object.values(user)[2]);
      console.log('check nguoi ban muon nhan tin', Object.values(user)[2])

      setImageUserWantMess(Object.values(user)[7]);
      // N·∫øu b·∫°n c·∫ßn x·ª≠ l√Ω d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ server, b·∫°n c√≥ th·ªÉ l√†m ·ªü ƒë√¢y
      // V√≠ d·ª•: const data = response.data;
    } catch (error) {
      // N·∫øu c√≥ l·ªói x·∫£y ra, in ra th√¥ng b√°o l·ªói
      console.error("L·ªói khi t·∫°o cu·ªôc tr√≤ chuy·ªán:", error);
    }
  };

  // L·∫•y gi√° tr·ªã c·ªßa thu·ªôc t√≠nh kh√¥ng r√µ t√™n
  console.log(TinNhan);

  const chatContainerRef = useRef(null);



  // --------------------------------------------------------
  useEffect(() => {
    const scrollToBottom = () => {
      chatContainerRef.current.scrollTop =
        chatContainerRef.current.scrollHeight;
    };
    scrollToBottom();
  }, [TinNhan]);

  // .................C·∫¨P NH·∫¨T AVATAR..............................
  const [selectedFile, setSelectedFile] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const AllUser = await axiosWithCredentials.get("http://localhost:3003/api/v1/user");
        setDataAllUserBackend(AllUser.data.DT);
        setAvatarUrl(AllUser.data.DT)

        console.log("=>user", AllUser.data.DT);

      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };
    fetchData()
  }, [])
  console.log("nguoima ban muon nhan tin =>", NguoiMaBanMuonNhanTin);
  console.log('check tin nhan TIN NHAN =>', TinNhan)
  return (
    <>
      <div className="container-chat-admin">
        <div className="container-chat-admin-headerListUser">
          {DataAllUserBackend.map((users) => (
            <div className={`headerListUser ${selectedUser === users.taikhoan ? 'selected' : ''}`} onClick={() => handleUserIb(users)}>
              <img
                src={users.avatar ? `http://localhost:3003/images/${users.avatar}` : `http://localhost:3003/images/avatatrang.jpg`}
                className="headerListUser-avata"
                alt="User Avatar"
              />

              <p>{users.ten ? users.ten : "Ng∆∞·ªùi B√≠ ·∫®n"}</p>
            </div>

          ))}
        </div>
        <div className="chat-container" ref={chatContainerRef}>
          {TinNhan.map((message) => (
            <div key={message._id} className={`message ${message.username !== 'admin' ? 'message-left' : 'message-right'}`}>
              {message.username === 'admin' && (
                <div className="container-messCha2">
                  <div className="container-noidungtinnhan2">
                    <p className="noidungtinnhan2">
                      {message.message}
                    </p>
                  </div>
                </div>
              )}
              {message.username !== 'admin' && (
                <div className="container-messCha">
                  <img
                    className="NoiDungChat-NoiDung-1-TinNhan-Avt image-Avta"
                    src={AvataKH ? `http://localhost:3003/images/${AvataKH}` : `${avat}`}
                    alt="User Avatar"
                  />

                  <div className="container-noidungtinnhan">
                    <p className="noidungtinnhan">
                      {message.message}
                    </p>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>





        <div className="container-chat-realtime-sendAdmin">
          <div className="NoiDungChat-thanhChat-Input">
            <input
              className="NoiDungChat-thanhChat-Input-1"
              placeholder="Aa"
              type="text"
              value={inputMess}
              onChange={(e) => setinputMess(e.target.value)}
              onKeyPress={(event) => handlePressEnter(event)}
            ></input>
          </div>
          <div className="NoiDungChat-thanhChat-3">
            <img
              onClick={handleIconCaVoi}
              className="CavoiCute"
              alt="üê≥"
              src="https://static.xx.fbcdn.net/images/emoji.php/v9/tde/1.5/20/1f433.png"
            ></img>
          </div>
        </div>
      </div >
    </>
  );
};

export default ChatAdmin;
